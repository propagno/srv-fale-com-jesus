version: "3.8"

services:
  app-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: srv-fale-com-jesus-dev
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      # Conecta ao banco de dados externo (db-propagno)
      # Use 'db-dev' como hostname quando estiver na mesma network Docker
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://${DB_HOST:-db-dev}:${DB_PORT:-1433};databaseName=${DB_NAME:-propagno_db};encrypt=true;trustServerCertificate=true
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-sa}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD_DEV:-YourStrong@Passw0rd}
      - JAVA_OPTS=-Xmx512m -Xms256m
    volumes:
      - ./src:/app/src
      - maven-cache:/root/.m2
    networks:
      - dev-network
      # Conecta Ã  network do banco de dados (se estiver rodando no mesmo host)
      - db-propagno-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  maven-cache:
    driver: local

networks:
  dev-network:
    driver: bridge
    name: srv-fale-com-jesus-dev-network
  # Network externa do banco de dados (deve existir no db-propagno)
  db-propagno-network:
    external: true
    name: db-propagno-network
