name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      image-tag:
        description: 'Tag da imagem para rollback (ex: main-abc123 ou v1.0.0)'
        required: true
        type: string
      reason:
        description: 'Motivo do rollback'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate image tag
        run: |
          if [ -z "${{ inputs.image-tag }}" ]; then
            echo "‚ùå Image tag is required"
            exit 1
          fi
          echo "‚úÖ Image tag validated: ${{ inputs.image-tag }}"

      - name: Create rollback backup
        run: |
          echo "üì¶ Creating backup before rollback..."
          # Comando para criar backup do estado atual

      - name: Rollback deployment
        run: |
          echo "üîÑ Rolling back to image: ${{ inputs.image-tag }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Reason: ${{ inputs.reason || 'Not specified' }}"
          
          # Aqui voc√™ adicionaria o comando real de rollback
          # Exemplo:
          # kubectl set image deployment/app app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image-tag }} -n ${{ inputs.environment }}
          # ou
          # docker-compose -f docker-compose.${{ inputs.environment }}.yml pull
          # docker-compose -f docker-compose.${{ inputs.environment }}.yml up -d

      - name: Health check after rollback
        run: |
          echo "‚è≥ Waiting for application to be healthy after rollback..."
          sleep 15
          
          case "${{ inputs.environment }}" in
            dev)
              HEALTH_URL="http://dev.example.com/actuator/health"
              ;;
            staging)
              HEALTH_URL="http://staging.example.com/actuator/health"
              ;;
            production)
              HEALTH_URL="http://prod.example.com/actuator/health"
              ;;
          esac
          
          # curl -f $HEALTH_URL || exit 1

      - name: Notify rollback
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå'
            const environment = '${{ inputs.environment }}'.toUpperCase()
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
              description: `Rollback ${environment}: ${status}`,
              context: `rollback/${inputs.environment}`
            })
