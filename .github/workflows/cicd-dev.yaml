name: CI/CD - Development

on:
    push:
        branches:
            - develop
        paths-ignore:
            - "**.md"
            - ".github/**"
    workflow_dispatch:
        inputs:
            force-deploy:
                description: "For√ßar deploy mesmo sem mudan√ßas"
                required: false
                default: false
                type: boolean

env:
    ENVIRONMENT: dev

jobs:
    build:
        name: Build and Push Image
        uses: ./.github/workflows/reusable/build-and-push.yaml
        with:
            java-version: "17"
            registry: ghcr.io
            image-name: ${{ github.repository }}
            dockerfile-path: ./docker/Dockerfile
            package-name: ${{ github.event.repository.name }}
            tag-suffix: dev-latest
        secrets:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    deploy:
        name: Deploy to Development
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: development
            url: http://dev.example.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Development
              run: |
                  echo "üöÄ Deploying to Development environment"
                  echo "Image: ${{ needs.build.outputs.image-tag }}"
                  echo "Version: ${{ needs.build.outputs.version }}"
                  # Aqui voc√™ adicionaria o comando real de deploy
                  # Exemplo: kubectl, docker-compose, terraform, etc.

            - name: Health Check
              run: |
                  echo "‚è≥ Waiting for application to be healthy..."
                  sleep 10
                  # curl -f http://dev.example.com/actuator/health || exit 1

            - name: Notify deployment
              uses: actions/github-script@v7
              if: always()
              with:
                  script: |
                      const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå'
                      github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.sha,
                        state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
                        description: `Deploy to DEV: ${status}`,
                        context: 'deployment/dev'
                      })
