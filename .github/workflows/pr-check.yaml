name: PR Check - Build and Test

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - develop
      - main
      - staging

jobs:
  validate:
    name: Validate PR Requirements
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
          scopes: |
            api
            db
            config
            docker
            ci
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            O tÃ­tulo do PR deve comeÃ§ar com letra minÃºscula e seguir o padrÃ£o:
            tipo(escopo): descriÃ§Ã£o
            Exemplo: feat(api): adiciona endpoint de usuÃ¡rios

      - name: Check for secrets
        run: |
          echo "ğŸ” Verificando se hÃ¡ secrets no cÃ³digo..."
          if grep -rE "(password|secret|token|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.java" --include="*.yml" --include="*.yaml" --include="*.properties" src/ docker/ 2>/dev/null | grep -v "YourStrong@Passw0rd" | grep -v "example"; then
            echo "âš ï¸  PossÃ­veis secrets encontrados no cÃ³digo!"
            echo "Por favor, remova secrets e use variÃ¡veis de ambiente"
            exit 1
          else
            echo "âœ… Nenhum secret encontrado"
          fi

      - name: Check for .env files
        run: |
          echo "ğŸ” Verificando arquivos .env..."
          if find . -name ".env*" -not -name ".env.example" | grep -q .; then
            echo "âŒ Arquivos .env encontrados no repositÃ³rio!"
            echo "Por favor, remova arquivos .env e use apenas .env.example"
            exit 1
          else
            echo "âœ… Nenhum arquivo .env encontrado"
          fi

      - name: Validate Dockerfile
        run: |
          echo "ğŸ” Validando Dockerfile..."
          if [ -f "docker/Dockerfile" ]; then
            if grep -iE "(password|secret|token)" docker/Dockerfile | grep -v "#" | grep -v "ENV"; then
              echo "âš ï¸  PossÃ­veis secrets no Dockerfile!"
              exit 1
            fi
            echo "âœ… Dockerfile validado"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    uses: ./.github/workflows/run-tests-reusable.yaml
    with:
      java-version: "17"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [validate, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Check code coverage
        run: mvn jacoco:report

      - name: Check coverage threshold
        run: |
          # Verifica se a cobertura estÃ¡ acima de 70%
          if mvn jacoco:check -Djacoco.minLineCoverage=0.70 -Djacoco.minBranchCoverage=0.70; then
            echo "âœ… Cobertura de testes OK (>= 70%)"
          else
            echo "âŒ Cobertura de testes abaixo de 70%"
            echo "Por favor, adicione mais testes antes de fazer merge"
            exit 1
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./target/site/jacoco/jacoco.xml
          fail_ci_if_error: false

      - name: Build Docker image (test)
        run: |
          docker build -t app-test:${{ github.sha }} -f docker/Dockerfile .
        if: success()

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const validateStatus = '${{ needs.validate.result }}' === 'success' ? 'âœ…' : 'âŒ'
            const testStatus = '${{ needs.test.result }}' === 'success' ? 'âœ…' : 'âŒ'
            const buildStatus = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ'
            
            const body = `## PR Check - Resultados
            
            ### ValidaÃ§Ãµes
            - ValidaÃ§Ã£o de tÃ­tulo: ${validateStatus}
            - VerificaÃ§Ã£o de secrets: ${validateStatus}
            - VerificaÃ§Ã£o de .env: ${validateStatus}
            - ValidaÃ§Ã£o de Dockerfile: ${validateStatus}
            
            ### Testes e Build
            - Testes unitÃ¡rios: ${testStatus}
            - Coverage >= 70%: ${buildStatus}
            - Build da aplicaÃ§Ã£o: ${buildStatus}
            
            ${buildStatus === 'âœ…' && validateStatus === 'âœ…' && testStatus === 'âœ…' ? 'âœ… **Tudo OK! PR pronto para review.**' : 'âŒ **Por favor, corrija os problemas identificados antes de fazer merge.**'}`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
