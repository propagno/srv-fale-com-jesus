name: Validate Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - develop
      - main
      - staging

jobs:
  validate-pr:
    name: Validate PR Requirements
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
          scopes: |
            api
            db
            config
            docker
            ci
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            O t√≠tulo do PR deve come√ßar com letra min√∫scula e seguir o padr√£o:
            tipo(escopo): descri√ß√£o
            Exemplo: feat(api): adiciona endpoint de usu√°rios

      - name: Check for secrets
        run: |
          echo "üîç Verificando se h√° secrets no c√≥digo..."
          # Verifica padr√µes comuns de secrets
          if grep -rE "(password|secret|token|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.java" --include="*.yml" --include="*.yaml" --include="*.properties" src/ docker/ 2>/dev/null | grep -v "YourStrong@Passw0rd" | grep -v "example"; then
            echo "‚ö†Ô∏è  Poss√≠veis secrets encontrados no c√≥digo!"
            echo "Por favor, remova secrets e use vari√°veis de ambiente"
            exit 1
          else
            echo "‚úÖ Nenhum secret encontrado"
          fi

      - name: Check for .env files
        run: |
          echo "üîç Verificando arquivos .env..."
          if find . -name ".env*" -not -name ".env.example" | grep -q .; then
            echo "‚ùå Arquivos .env encontrados no reposit√≥rio!"
            echo "Por favor, remova arquivos .env e use apenas .env.example"
            exit 1
          else
            echo "‚úÖ Nenhum arquivo .env encontrado"
          fi

      - name: Validate Dockerfile
        run: |
          echo "üîç Validando Dockerfile..."
          if [ -f "docker/Dockerfile" ]; then
            # Verifica se h√° secrets hardcoded
            if grep -iE "(password|secret|token)" docker/Dockerfile | grep -v "#" | grep -v "ENV"; then
              echo "‚ö†Ô∏è  Poss√≠veis secrets no Dockerfile!"
              exit 1
            fi
            echo "‚úÖ Dockerfile validado"
          fi

      - name: Check documentation
        run: |
          echo "üîç Verificando documenta√ß√£o..."
          REQUIRED_DOCS=("README.md" "QUICKSTART.md")
          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ö†Ô∏è  Documento $doc n√£o encontrado"
              MISSING=1
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "Por favor, adicione a documenta√ß√£o faltante"
            exit 1
          else
            echo "‚úÖ Documenta√ß√£o OK"
          fi

      - name: Comment PR with validation results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå'
            const body = `## Valida√ß√£o de PR ${status}
            
            - Valida√ß√£o de t√≠tulo: ${status}
            - Verifica√ß√£o de secrets: ${status}
            - Verifica√ß√£o de .env: ${status}
            - Valida√ß√£o de Dockerfile: ${status}
            - Verifica√ß√£o de documenta√ß√£o: ${status}
            
            ${status === '‚úÖ' ? 'Tudo OK! PR pronto para review.' : 'Por favor, corrija os problemas identificados.'}`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

