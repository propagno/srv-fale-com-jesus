name: Build and Push Docker Image

on:
    workflow_call:
        inputs:
            java-version:
                description: "Java version"
                required: false
                type: string
                default: "17"
            registry:
                description: "Docker registry URL"
                required: false
                type: string
                default: "ghcr.io"
            image-name:
                description: "Docker image name"
                required: true
                type: string
            dockerfile-path:
                description: "Path to Dockerfile"
                required: false
                type: string
                default: "./docker/Dockerfile"
            package-name:
                description: "Package/artifact name"
                required: false
                type: string
            tag-suffix:
                description: "Additional tag suffix (e.g., dev-latest, staging-latest)"
                required: false
                type: string
                default: ""
        secrets:
            GITHUB_TOKEN:
                required: false
            DOCKER_USERNAME:
                required: false
            DOCKER_PASSWORD:
                required: false
        outputs:
            image-tag:
                description: "Full image tag"
                value: ${{ jobs.build.outputs.image-tag }}
            image-digest:
                description: "Image digest"
                value: ${{ jobs.build.outputs.image-digest }}
            version:
                description: "Application version"
                value: ${{ jobs.build.outputs.version }}

jobs:
    build:
        name: Build and Push
        runs-on: ubuntu-latest
        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}
            image-digest: ${{ steps.build.outputs.digest }}
            version: ${{ steps.meta.outputs.version }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK
              uses: actions/setup-java@v4
              with:
                  java-version: ${{ inputs.java-version }}
                  distribution: "temurin"
                  cache: "maven"

            - name: Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Run tests
              run: mvn clean test
              continue-on-error: true

            - name: Build application
              run: mvn clean package -DskipTests

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ inputs.registry }}
                  username: ${{ inputs.registry == 'ghcr.io' && github.actor || secrets.DOCKER_USERNAME }}
                  password: ${{ inputs.registry == 'ghcr.io' && secrets.GITHUB_TOKEN || secrets.DOCKER_PASSWORD }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ inputs.registry }}/${{ inputs.image-name }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      ${{ inputs.tag-suffix != '' && format('type=raw,value={0}', inputs.tag-suffix) || '' }}

            - name: Build and push Docker image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ${{ inputs.dockerfile-path }}
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      PACKAGE_NAME=${{ inputs.package-name || github.event.repository.name }}
