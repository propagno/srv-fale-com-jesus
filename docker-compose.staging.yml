version: '3.8'

services:
  app-staging:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_NAME:-your-org/your-app}:staging-latest
    container_name: app-staging
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=staging
      # Conecta ao banco de dados externo (db-propagno)
      # Use 'db-staging' como hostname quando estiver na mesma network Docker
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://${DB_HOST:-db-staging}:${DB_PORT:-1433};databaseName=${DB_NAME:-propagno_db_staging};encrypt=true;trustServerCertificate=true
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-sa}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD_STAGING}
      - JAVA_OPTS=-Xmx1024m -Xms512m
    networks:
      - staging-network
      # Conecta Ã  network do banco de dados (se estiver rodando no mesmo host)
      - db-propagno-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis-staging:
    image: redis:7-alpine
    container_name: redis-staging
    ports:
      - "6380:6379"
    volumes:
      - redis-staging-data:/data
    networks:
      - staging-network
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  redis-staging-data:
    driver: local

networks:
  staging-network:
    driver: bridge
    name: app-staging-network
  # Network externa do banco de dados (deve existir no db-propagno)
  db-propagno-network:
    external: true
    name: db-propagno-network
